if(!FPhi)var FPhi={};FPhi.UserControlMode={Register:0,Authenticate:1},FPhi.LivenessMode={None:0,Blink:1,Move:2},FPhi.ExceptionType={CameraError:0,ExtractorError:1,ControlNotInitializedError:2,ImageCropResizeError:3,UnexpectedCaptureError:4},FPhi.ImageFormat={None:0,Gray_8bpp:1,RGB_24bpp:2,BGR_24bpp:3,ARGB_32bpp:4,YUV_NV21:5,ABGR_32bpp:6,BGRA_32bpp:7,RGBA_32bpp:8},FPhi.SampleDiagnostic={Ok:0,FaceNotFound:1,RightEyeNotFound:2,LeftEyeNotFound:3,EyesNotFound:4,FaceTooFar:5,FaceTooClose:6,TooCloseToWindowSide:7,AngleExceeded:8,QualityCheckFailed:9,NotRated:10},FPhi.FinalDiagnostic={InsufficientValidSamples:0,TemplateCreationInProgress:1,TemplateCreated:2},FPhi.LivenessDiagnostic={NotRated:0,PhotoDetected:1,LivenessDetected:2,Unsuccess:3,UnsuccessLowPerformance:4,UnsuccessGlasses:5,UnsuccessLight:6,UnsuccessNoMovement:7,UnsuccessWrongDirection:8,UnsuccessTooFar:9},FPhi.UserControl=function(e,t,i,a,n,s,o,r,d,l,c,m,v,g,h,u,p){this.debug&&console.log("Timing-Constructor: "+performance.now()),this.divContainer=document.getElementById(e),this.onModuleLoaded=a,this.onExtractionFinish=n,this.onUserCancel=s,this.onExceptionCaptured=o,this.onExtractionTimeout=r,this.onLivenessError=d,this.onLivenessErrorButtonClick=l,this.onTimeoutErrorButtonClick=c,this.onStabilizing=m,this.livenessMoveTimer=new FPhi.Timer,this.cameraReady=!1,this.path=this.getScriptPath("FPhi.Widget.wasm.js"),this.wasmReady=!1,this.wasmInitiated=!1,this.worker=new Worker(this.path+"FPhi.Widget.worker.wasm.js"),this.worker.onmessage=this.handleExtractorMessage.bind(this),this.worker.widget=this,this.queuedCommands=0,this.resourceParent=null,this.language=v,this.cameraWidth=t,this.cameraHeight=i,this.canvasWidth=500,this.canvasHeight=500,void 0!=u&&(this.canvasWidth=u),void 0!=p&&(this.canvasHeight=p),this.fontSizeFactor=this.canvasHeight/500,this.canvasSizeFactor=this.canvasHeight/500,this.buttonHeight*=this.canvasSizeFactor,this.fpsTime=performance.now(),this.baseURL=g,this.dpiList=h,null!=document.getElementById("FPhi_Widget_rm_script")&&document.head.removeChild(document.getElementById("FPhi_Widget_rm_script")),this.rmScript=document.createElement("script"),this.rmScript.id="FPhi_Widget_rm_script",this.rmReady=!1,this.rmScript.type="text/javascript",this.rmScript.src=this.path+"FPhi.Widget.rm.wasm.js",this.rmScript.onreadystatechange=this.OnResourceManagerLoaded.bind(this),this.rmScript.onload=this.OnResourceManagerLoaded.bind(this),document.getElementsByTagName("head")[0].appendChild(this.rmScript),null!=document.getElementById("FPhi_Widget_graph_script")&&document.head.removeChild(document.getElementById("FPhi_Widget_graph_script")),this.graphScript=document.createElement("script"),this.graphScript.id="FPhi_Widget_graph_script",this.graphReady=!1,this.graphScript.type="text/javascript",this.graphScript.src=this.path+"FPhi.Widget.graph.wasm.js",this.graphScript.onreadystatechange=this.OnGraphLoaded.bind(this),this.graphScript.onload=this.OnGraphLoaded.bind(this),document.getElementsByTagName("head")[0].appendChild(this.graphScript),null!=document.getElementById("FPhi_Widget_drawer_script")&&document.head.removeChild(document.getElementById("FPhi_Widget_drawer_script")),this.drawerScript=document.createElement("script"),this.drawerScript.id="FPhi_Widget_drawer_script",this.drawerScript.type="text/javascript",this.drawerScript.src=this.path+"FPhi.Widget.drawer.wasm.js",this.drawerScript.onload=this.OnDrawerLoaded.bind(this),document.getElementsByTagName("head")[0].appendChild(this.drawerScript),this.divContainer.addEventListener("FPhi.UserControl.Finish.event",n,!0),this.divContainer.addEventListener("FPhi.UserControl.UserCancel.event",s,!0),this.divContainer.addEventListener("FPhi.UserControl.ExtractionTimeout.event",r,!0),this.divContainer.addEventListener("FPhi.UserControl.LivenessError.event",d,!0),this.divContainer.addEventListener("FPhi.UserControl.LivenessErrorButtonClick.event",l,!0),this.divContainer.addEventListener("FPhi.UserControl.TimeoutErrorButtonClick.event",c,!0),this.divContainer.addEventListener("FPhi.UserControl.ModuleLoaded.event",a,!0),this.divContainer.addEventListener("FPhi.UserControl.ExceptionCaptured.event",o,!0),this.divContainer.addEventListener("FPhi.UserControl.Stabilizing.event",m,!0),this.imageCamera=document.createElement("img"),this.imageCamera.src=this.path+FPhi.UserControl.Images.noCamerasUrl,this.cameraContainer=document.createElement("div"),this.cameraContainer.id="cameraContainer",this.divContainer.appendChild(this.cameraContainer);var f=document.getElementById("gifWaiting");if(null!=f&&(f.style.display="none"),0>=this.cropFactor){var C=new CustomEvent("FPhi.UserControl.ExceptionCaptured.event",{detail:{message:"Invalid value of CropFactor. Must be greather than 0.",exceptionType:3}});this.divContainer.dispatchEvent(C),this.cropFactor=1}if(0>=this.resizeFactor){var C=new CustomEvent("FPhi.UserControl.ExceptionCaptured.event",{detail:{message:"Invalid value of ResizeFactor. Must be greather than 0.",exceptionType:3}});this.divContainer.dispatchEvent(C),this.resizeFactor=1}0>=this.sceneTimeout&&(this.sceneTimeout=0),this.debug&&console.log("Timing-Constructor-end: "+performance.now())},FPhi.UserControl.Color={leftButtonColor:"rgba(16,163,199,1)",rightButtonColor:"rgba(164,164,164,1)",leftButtonTextColor:"rgba(255,255,255,1)",rightButtonTextColor:"rgba(255,255,255,1)",redColor:"rgba(255,0,0,1)",blueColor:"rgba(16,163,199,1)",greenColor:"rgba(63,183,109,1)",orangeColor:"rgba(240, 154, 71, 1)",blackColor:"rgba(0,0,0,1)",whiteColor:"rgba(255,255,255,1)",grayColor:"rgba(255,255,255,0.7)",grayColor2:"rgba(0,0,0,0.7)",grayColor3:"rgba(127,125,125,1)",grayColor4:"rgba(127,127,127,0.3)",blindColor:"rgba(16,163,199,0.5)"},FPhi.UserControl.Images={timeOutUrl:"../FPhi.Widget.Common/Images/timeout.png",livenessErrorUrl:"../FPhi.Widget.Common/Images/livenessError.png",livenessGlassesUrl:"../FPhi.Widget.Common/Images/livenessGlasses.png",livenessLightsUrl:"../FPhi.Widget.Common/Images/livenessLights.png",livenessPerformanceUrl:"../FPhi.Widget.Common/Images/livenessPerformance.png",noCamerasUrl:"../FPhi.Widget.Common/Images/errorNoCamsEs.png"},FPhi.UserControl.prototype={constructor:FPhi.UserControl,extractionMode:FPhi.UserControlMode.Authenticate,livenessMode:FPhi.LivenessMode.None,language:"es",userTags:null,privateCanvas:null,extractor:null,extractorLiveness:null,extractorVersion:"",livenessTimer:null,lastDetectResult:null,lastExtractionResult:null,lastExtractionResultWizard:null,faceAvailable:!0,faceDataRect:null,faceAvailableDelayed:!0,faceTooFar:!1,bestScore:0,actualTime:0,actualTimePrev:0,clockWaitingFace:null,clockWaitingStart:null,clockExtraction:null,clockExtractionPure:null,clockCycleTip:null,clockWizardCompleted:null,clockShowResults:null,clockImprove:null,clockLiveness1:null,clockLiveness2:null,clockLiveness3:null,clockLiveness3_finish:null,clockFinish:null,clockNewScenario:null,clockWarningIn:null,clockWarningOut:null,clockEyeDetection:null,clockEyeDetectionDetected:null,waitingTimeStart:3,extractionTime:5,extractionTimePartial:0,extractionSmartMinScore:.5,liveness1Time:.5,liveness3Time:.25,livenessActualRetrain:0,livenessCalculating:!1,livenessErrorString:"",livenessErrorImage:null,livenessMoveDirection:-1,livenessMoveActualSuccessfulAttempts:0,livenessMoveActualFailedAttempts:0,livenessMoveNextIndex:0,livenessMoveGlassesFail:0,livenessMoveInit:!1,livenessMoveFailReason:0,livenessMoveInfoTime:3,livenessMoveLastStabilizedStatus:0,livenessMoveStabilizedStatusHistory:[],livenessMoveHistory:[],livenessPrecision:0,showImproveButton:!1,maxResults:15,graphicalScoreMax:0,privateLastImage:null,privateImages:[],logImages:!1,logAllImages:!1,faceTracking:!1,privateLivenessImages:[],privateLivenessImageTemp:null,privateLivenessTimerDiagnostic:null,privateLivenessResults:[],privateEyesYLevel:0,idContainer:null,divContainer:null,extractorContainer:null,videoSelectId:null,cameraContainer:null,cameraWidth:null,cameraHeight:null,cameraRotation:0,canvasWidth:null,canvasHeight:null,cameraStream:null,selectedSource:null,samplePeriod:0,buttonHeight:50,debug:!1,interactible:!0,imageFormat:"image/jpeg",forceMoveDirection:-1,registerTime:7,authenticateTime:1,globalTimeout:30,fps:0,fpse:0,fpsframes:0,fpseFrames:0,fpsTime:null,fontSizeFactor:1,canvasSizeFactor:1,imageTips1:null,imageTips2:null,imageFaceMoving:[],imageCheck:null,imageError:null,imageArrow:null,imageCamera:null,cropImage:!0,cropFactor:1,resizeFactor:1,warningInTime:.8,warningOutTime:0,detectionTimeout:3e4,extractionTimeout:3e4,sceneTimeout:0,secondsWidget:0,secondsState:0,sendingTimeout:2,cameraList:[],graphPath:"graph.xml",Start:function(){this.debug&&console.log("Timing-Start: "+performance.now()),this.selectedSource=null,this.initCamera(this.cameraContainer,this.cameraWidth,this.cameraHeight),this.setVideoInput(this),this.widgetTime=performance.now(),this.stateTime=this.widgetTime,this.debug&&console.log("Timing-Start-end: "+performance.now())},Stop:function(){null!=this.worker&&(this.postMessage(this,{cmd:"destroy"}),this.worker.widget=null,this.worker=null),null!=this.divContainer&&(this.divContainer.removeEventListener("FPhi.UserControl.Finish.event",this.onExtractionFinish,!0),this.divContainer.removeEventListener("FPhi.UserControl.UserCancel.event",this.onUserCancel,!0),this.divContainer.removeEventListener("FPhi.UserControl.ExtractionTimeout.event",this.onExtractionTimeout,!0),this.divContainer.removeEventListener("FPhi.UserControl.LivenessError.event",this.onLivenessError,!0),this.divContainer.removeEventListener("FPhi.UserControl.LivenessErrorButtonClick.event",this.onLivenessErrorButtonClick,!0),this.divContainer.removeEventListener("FPhi.UserControl.TimeoutErrorButtonClick.event",this.onTimeoutErrorButtonClick,!0),this.divContainer.removeEventListener("FPhi.UserControl.ModuleLoaded.event",this.onModuleLoaded,!0),this.divContainer.removeEventListener("FPhi.UserControl.ExceptionCaptured.event",this.onExceptionCaptured,!0),this.divContainer.removeEventListener("FPhi.UserControl.Stabilizing.event",this.onStabilizing,!0),this.divContainer.removeChild(this.cameraContainer),this.divContainer=null,this.cameraContainer=null),null!=this.cameraStream&&this.cameraStream.getVideoTracks()[0].stop(),null!=this.rm&&(this.rm.caller=null,this.rm=null),null!=this.graph&&(this.graph=null),null!=this.drawer&&(this.drawer=null),null!=this.rmScript&&(this.rmScript.onreadystatechange=null,this.rmScript.onload=null,this.rmScript=null),null!=this.graphScript&&(this.graphScript.onreadystatechange=null,this.graphScript.onload=null,this.graphScript=null),null!=this.drawerScript&&(this.drawerScript.onload=null,this.drawerScript=null)},GetAvailableCameras:function(){return navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(this.gotDevices).catch(this.handleCameraError):(console.log("GetMediaDevices not available for this browser"),null)},postMessage:function(e,t){e.queuedCommands++,e.worker.postMessage(t)},setLastExtractionResult:function(e,t){null!=e.lastExtractionResult&&e.lastExtractionResult.delete(),e.lastExtractionResult=t},OnGraphNewState:function(e){if(this.stateTime=performance.now(),"UCNothing"==this.state&&(this.widgetTime=this.stateTime),this.secondsWidget=(this.actualTime-this.widgetTime)/1e3,this.secondsState=(this.actualTime-this.stateTime)/1e3,this.state=e,this.resourceParent=this.drawer.getResourceIdForState(e),this.debug&&console.log("state: "+e),this.elements=null,null!=this.resourceParent&&(this.elements=this.rm.getElements(this.resourceParent),this.startVideos(this)),"UCNothing"==e)this.clockNewScenario=performance.now(),this.lastExtractionResult=null,this.bestScore=0,this.faceAvailable=!1,this.clockWaitingStart=null,this.clockExtraction=null,this.clockExtractionPure=null,this.clockLiveness=null,this.extractionTime=this.extractionMode==FPhi.UserControlMode.Register?this.registerTime:this.livenessMode==FPhi.LivenessMode.Move?0:this.authenticateTime,this.livenessCalculating=!1,this.privateLastImage=null,this.privateImages=[],this.privateLivenessImages=[],this.privateLivenessResults=[],this.livenessActualRetrain=0,this.livenessErrorString=null;else if("UCTutorialRegister2"==e)this.clockNewScenario=performance.now();else if("UCWaitingFaceStart"==e)this.clockNewScenario=performance.now(),this.extractionMode==FPhi.UserControlMode.Authenticate&&this.livenessMode==FPhi.LivenessMode.Blink&&(this.postMessage(this,{cmd:"livenessTimerSetValues",timeLapse:700,fps:10}),this.postMessage(this,{cmd:"livenessTimerReset"})),!1==this.interactible&&this.graph.sendMessage("Click//button_start");else if("UCSelectTutorial"==e)this.graph.sendMessage("SetMode//"+this.extractionMode+","+this.livenessMode);else if("UCExtracting"==e)this.clockNewScenario=performance.now(),this.clockExtraction=performance.now(),this.clockExtractionPure=this.clockExtraction,this.extractionTimePartial=0,this.postMessage(this,{cmd:"initStreamExtraction",extractionMode:this.extractionMode,livenessMode:this.livenessMode,userTags:this.userTags});else if("UCShowResults"==e)this.clockNewScenario=performance.now(),this.clockShowResults=performance.now(),null!=this.lastExtractionResultWizard&&(this.setLastExtractionResult(this.lastExtractionResultWizard),this.lastExtractionResultWizard=null);else if("UCCancelByUser"==e){this.clockNewScenario=performance.now();var t=new CustomEvent("FPhi.UserControl.UserCancel.event");this.divContainer.dispatchEvent(t),this.Stop()}else if("UCLivenessDetectionStep1"==e)this.clockNewScenario=performance.now(),this.clockLiveness1=performance.now();else if("UCLivenessDetectionStep2"==e)this.clockLiveness2=performance.now(),this.privateLivenessImages=[],this.privateLivenessResults=[],this.postMessage(this,{cmd:"livenessTimerReset"});else if("UCLivenessDetectionStep3"==e)this.clockLiveness3_finish=null,this.clockLiveness3=performance.now(),this.postMessage(this,{cmd:"evaluateLiveness",images:this.privateLivenessImages,template:this.lastExtractionResult.Template});else if("UCWaitingEyeDetection"==e)this.clockNewScenario=performance.now(),this.clockEyeDetection=performance.now(),this.clockEyeDetectionDetected=null;else if("UCFinish"==e){this.clockNewScenario=performance.now(),this.clockFinish=performance.now(),this.logAllImages||this.sortImagesByFacialScore(this,this.privateImages);for(var i=[],n=0;n<this.privateImages.length;n++)void 0!=this.privateImages[n]&&i.push(this.getImgTag(this.privateImages[n],this.cropImage,this.cropFactor,this.resizeFactor));var a;void 0!=this.lastExtractionResult.templateRaw&&(a=this.lastExtractionResult.templateRaw);var s={template:this.lastExtractionResult.template,images:i,timeStamp:this.privateLivenessResults,templateRaw:a,livenessMoveFails:this.livenessMoveActualFailedAttempts,sunGlassesScore:this.lastExtractionResult.sunGlassesScore,livenessMoveHistory:this.livenessMoveHistory,livenessMoveStabilizedHistory:this.livenessMoveStabilizedStatusHistory,livenessMoveStabilizedStatus:this.livenessMoveLastStabilizedStatus},t=new CustomEvent("FPhi.UserControl.Finish.event",{detail:s});this.divContainer.dispatchEvent(t),this.Stop()}else if("UCErrors"==e){var s={livenessMoveFails:this.livenessMoveActualFailedAttempts,livenessMoveHistory:this.livenessMoveHistory,livenessMoveStabilizedHistory:this.livenessMoveStabilizedStatusHistory,livenessMoveStabilizedStatus:this.livenessMoveLastStabilizedStatus};if(null!=this.lastExtractionResult&&null!=this.lastExtractionResult.sunGlassesScore&&(s.sunGlassesScore=this.lastExtractionResult.sunGlassesScore),this.logAllImages){for(var i=[],n=0;n<this.privateImages.length;n++)void 0!=this.privateImages[n]&&i.push(this.getImgTag(this.privateImages[n],this.cropImage,this.cropFactor,this.resizeFactor));s.images=i,s.timeStamp=this.privateLivenessResults}if(this.clockNewScenario=performance.now(),0>this.livenessDiagnostic)this.divContainer.dispatchEvent(new CustomEvent("FPhi.UserControl.ExtractionTimeout.event",{detail:s}));else{s.livenessErrorType=this.livenessDiagnostic;var t=new CustomEvent("FPhi.UserControl.LivenessError.event",{detail:s});this.divContainer.dispatchEvent(t)}}else if("UCLivenessMoveStabilizing"==e)this.livenessMoveTimer.SetValues(1750,12,0),this.postMessage(this,{cmd:"initLivenessMoveStabilization"});else if("UCLivenessMoveStabilized"==e)this.livenessMoveTimer.Reset(),!1==this.livenessMoveInit&&(this.postMessage(this,{cmd:"initLivenessMoveSequence",livenessPrecision:facePhiUserControl.config.livenessPrecision}),this.livenessMoveInit=!0),this.postMessage(this,{cmd:"nextLivenessMoveSequence"}),this.livenessMoveNextIndex=0;else if("UCLivenessMoveDetecting"==e)this.privateLivenessImages=[];else if("UCLivenessMoveProcessing"==e);null!=this.graph&&this.graph.sendMessage("SetStatusFinished")},getImageData:function(e){var t=e.getContext("2d"),i=e.height,a=e.width,n=t.getImageData(0,0,a,i),s={width:a,height:i,pixels:n,time:performance.now()};return s},getImgTag:function(e,t,i,a){var n=document.createElement("canvas");n.width=e.width,n.height=e.height,n.getContext("2d").putImageData(e.pixels,0,0);var s=document.createElement("canvas");if(t&&void 0!=e.extractionResult&&void 0!=e.extractionResult.face){var o=e.extractionResult.face.width*i,r=e.extractionResult.face.height*i,d=e.extractionResult.face.x-(i-1)*e.extractionResult.face.width/2,l=e.extractionResult.face.y-(i-1)*e.extractionResult.face.height/2;0>d&&(o+=d,d=0),0>l&&(r+=l,l=0),d+o>=e.width&&(o=e.width-d),l+r>=e.height&&(r=e.height-l),s.width=o,s.height=r,s.getContext("2d").drawImage(n,d,l,o,r,0,0,s.width,s.height)}else s.width=e.width*a,s.height=e.height*a,s.getContext("2d").drawImage(n,0,0,s.width,s.height);var c=document.createElement("img");return c.src=s.toDataURL(this.imageFormat),c},handleExtractorMessage:function(e){this.fpseframes++;var t=this.faceAvailable;if(this.queuedCommands--,"ready"==e.data.cmd)this.queuedCommands++,this.wasmReady=!0,this.debug&&console.log("Timing-Worker-ready: "+performance.now());else if("detect"==e.data.cmd){this.lastDetectResult=e.data,this.faceAvailable=!1;var i=this.lastDetectResult;if(i.sampleDiagnostic==FPhi.SampleDiagnostic.Ok){if(i.face){var a=this.fromCameraToScreenDetection(this,i.face);this.faceInsideCircle(this,a)&&(this.faceAvailable=!0,this.faceDataRect=a)}if(i.leftEye){var a=this.fromCameraToScreenDetection(this,{x:i.leftEye.x,y:i.leftEye.y,width:1,height:1});this.privateEyesYLevel=a.y,this.leftEyeData=a}if(i.rightEye){var a=this.fromCameraToScreenDetection(this,{x:i.rightEye.x,y:i.rightEye.y,width:1,height:1});this.rightEyeData=a}}this.faceTooFar=i.sampleDiagnostic==FPhi.SampleDiagnostic.FaceTooFar,"UCWaitingEyeDetection"==this.state&&this.faceAvailable&&null==this.clockEyeDetectionDetected&&(this.clockEyeDetectionDetected=performance.now())}else if("extractNextSmart"==e.data.cmd){var n=e.data;if(this.faceTooFar=e.data.sampleDiagnostic==FPhi.SampleDiagnostic.FaceTooFar,this.faceAvailable=!1,n.sampleDiagnostic==FPhi.SampleDiagnostic.Ok){this.lastExtractionResult=e.data;var a=this.fromCameraToScreenDetection(this,this.lastExtractionResult.face);this.faceInsideCircle(this,a)&&(this.faceAvailable=!0,this.faceDataRect=a)}if(n.leftEye){var a=this.fromCameraToScreenDetection(this,{x:n.leftEye.x,y:n.leftEye.y,width:1,height:1});this.privateEyesYLevel=a.y,this.leftEyeData=a}if(n.rightEye){var a=this.fromCameraToScreenDetection(this,{x:n.rightEye.x,y:n.rightEye.y,width:1,height:1});this.privateEyesYLevel=a.y,this.rightEyeData=a}"UCExtracting"==this.state&&(this.privateLastImage.extractionResult=n,this.logAllImages&&(this.privateImages.push(this.privateLastImage),this.privateLivenessResults.push(this.secondsWidget)),n.sampleDiagnostic==FPhi.SampleDiagnostic.Ok&&!0==this.faceAvailable&&(!this.logAllImages&&this.logImages?this.privateImages.push(this.privateLastImage):5>this.privateImages.length?this.privateImages.push(this.privateLastImage):this.betterSustitution(this,this.privateImages,this.privateLastImage)))}else if("evaluateLiveness"==e.data.cmd)e.data.livenessDiagnostic==FPhi.LivenessDiagnostic.LivenessDetected?this.graph.sendMessage("AuthenticationFinished"):(this.livenessActualRetrain+=e.data.penalty,3<=this.livenessActualRetrain?(this.livenessDiagnostic=e.data.livenessDiagnostic,this.graph.sendMessage("Errors")):this.clockLiveness3_finish=this.actualTime);else if("livenessTimerReset"==e.data.cmd);else if("livenessTimerSetValues"==e.data.cmd);else if("livenessTimerAdd"==e.data.cmd)!0==e.data.status&&this.privateLivenessImages.push(this.privateLivenessImageTemp),!0==e.data.isFull&&(this.privateLivenessTimerDiagnostic=e.data.livenessTimerDiagnostic,this.graph.sendMessage("LivenessTimerFull"));else if("nextLivenessMoveSequence"==e.data.cmd)this.livenessMoveDirection=e.data.direction,-1!=this.forceMoveDirection&&(this.livenessMoveDirection=this.forceMoveDirection);else if("nextLivenessMoveStabilization"==e.data.cmd){var n=e.data;if(this.faceTooFar=3==n.faceStabilized,this.faceAvailable=!1,n.sampleDiagnostic==FPhi.SampleDiagnostic.Ok){this.livenessMoveLastStabilizedStatus=n.faceStabilized,this.lastExtractionResult=e.data;var a=this.fromCameraToScreenDetection(this,this.lastExtractionResult.face);this.faceInsideCircle(this,a)&&(this.faceAvailable=!0,this.faceDataRect=a)}if(n.leftEye){var a=this.fromCameraToScreenDetection(this,{x:n.leftEye.x,y:n.leftEye.y,width:1,height:1});this.privateEyesYLevel=a.y,this.leftEyeData=a}if(n.rightEye){var a=this.fromCameraToScreenDetection(this,{x:n.rightEye.x,y:n.rightEye.y,width:1,height:1});this.privateEyesYLevel=a.y,this.rightEyeData=a}if(this.privateLastImage.extractionResult=n,n.sampleDiagnostic==FPhi.SampleDiagnostic.Ok&&!0==this.faceAvailable&&(1==n.faceStabilized||17==n.faceStabilized)&&(this.logImages&&(this.privateImages.push(this.privateLastImage),this.privateLivenessResults.push(this.secondsWidget)),this.livenessMoveStabilizedStatusHistory.push(n.faceStabilized),this.graph.sendMessage("FaceStabilized")),4==n.faceStabilized&&(this.livenessMoveGlassesFail++,this.livenessMoveFailReason=0,this.livenessMoveStabilizedStatusHistory.push(n.faceStabilized),this.graph.sendMessage("GlassesFound//"+this.livenessMoveGlassesFail)),null!=n.faceStabilized){var s=new CustomEvent("FPhi.UserControl.Stabilizing.event",{detail:n.faceStabilized});this.divContainer.dispatchEvent(s)}}else if("nextLivenessMoveImage"==e.data.cmd)this.livenessCalculating=!1,this.logImages||this.logAllImages||(this.privateLivenessImages[this.livenessMoveNextIndex]=null),this.livenessMoveNextIndex++;else if("evaluateLivenessMove"==e.data.cmd){this.livenessCalculating=!1;var n=e.data;this.lastExtractionResult=e.data,this.livenessMoveHistory.push(n.livenessDiagnostic),n.livenessDiagnostic==FPhi.LivenessDiagnostic.LivenessDetected?(this.livenessMoveActualSuccessfulAttempts++,this.livenessMoveLastAttempSuccessful=!0,this.graph.sendMessage("LivenessMoveRetry//"+this.livenessMoveActualSuccessfulAttempts+","+this.livenessMoveActualFailedAttempts)):(this.livenessMoveFailReason=1,this.livenessDiagnostic=n.livenessDiagnostic,this.livenessMoveActualFailedAttempts++,this.livenessMoveLastAttempSuccessful=!1,17==this.livenessMoveLastStabilizedStatus&&1>=this.livenessMoveActualFailedAttempts?(this.livenessMoveFailReason=2,this.graph.sendMessage("LivenessMoveGlasses")):this.graph.sendMessage("LivenessMoveRetry//"+this.livenessMoveActualSuccessfulAttempts+","+this.livenessMoveActualFailedAttempts))}this.faceTooFar&&(this.faceAvailable=!1),!0==t&&!1==this.faceAvailable?this.clockWarningIn=this.actualTime:!1==t&&!0==this.faceAvailable?this.clockWarningOut=this.actualTime:this.faceAvailable&&this.actualTime-this.clockWarningOut>1e3*this.warningOutTime?this.faceAvailableDelayed=this.faceAvailable:!this.faceAvailable&&this.actualTime-this.clockWarningIn>1e3*this.warningInTime&&(this.faceAvailableDelayed=this.faceAvailable)},startVideos:function(e){if(null!=e.elements)for(var t=0;t<e.elements.length;t++)if("video"==e.elements[t].type){var i=document.createElement("video");i.hidden=!0,i.playsinline=!0,i.loop=!1,i.muted=!0,i.autoplay=!0,i.controls=!0,i.src=e.rm.getResourceUrlBase(e.rm.getSetupResourceId(e.resourceParent,e.elements[t].id,"value")),i.addEventListener("ended",e.videoplayerEnded.bind(e),!1),i.setAttribute("playsinline",""),i.setAttribute("webkit-playsinline",""),i.play(),e.elements[t].videoPlayer=i}},canvasOnMove:function(t){if(void 0!=this.elements)for(var e=this.elements.length-1;0<=e;e--)if(void 0!=this.elements[e].layout&&t.offsetX>=this.elements[e].layout.x&&t.offsetX<this.elements[e].layout.x+this.elements[e].layout.width&&t.offsetY>=this.elements[e].layout.y&&t.offsetY<this.elements[e].layout.y+this.elements[e].layout.height){if(this.extractionMode==FPhi.UserControlMode.Authenticate&&this.livenessMode!=FPhi.LivenessMode.Blink&&"button_info"==this.elements[e].id)break;this.drawer.onMouseMove(t.target,this.elements[e].layout,this.resourceParent,this.elements[e].id,this.elements[e].type);break}},canvasOnClick:function(t){if("UCErrors"==this.state){var e=t.offsetX,i=t.offsetY,n=this.canvasHeight-this.buttonHeight;if(i>n){var s;-1==this.livenessDiagnostic?(s=new CustomEvent("FPhi.UserControl.TimeoutErrorButtonClick.event"),this.divContainer.dispatchEvent(s)):(s=new CustomEvent("FPhi.UserControl.LivenessErrorButtonClick.event"),this.divContainer.dispatchEvent(s))}}else{if(this.elements==void 0)return;for(var o=this.elements.length-1;0<=o;o--)if(null!=this.elements[o].layout&&t.offsetX>=this.elements[o].layout.x&&t.offsetX<this.elements[o].layout.x+this.elements[o].layout.width&&t.offsetY>=this.elements[o].layout.y&&t.offsetY<this.elements[o].layout.y+this.elements[o].layout.height){var a="Click//"+this.elements[o].id;this.graph.sendMessage(a);break}}},initCamera:function(e,t,i){var a=document.getElementById("display");if(-1<!e.innerHTML.indexOf("video")){var n=document.createElement("video");n.id="live",n.width="auto",n.height="auto",n.setAttribute("playsinline",""),n.setAttribute("webkit-playsinline",""),n.setAttribute("autoplay",""),n.setAttribute("muted",""),n.style="position:fixed; top:-10000px;",e.appendChild(n);var s=document.createElement("canvas");s.id="display",s.width=this.canvasWidth,s.height=this.canvasHeight,e.appendChild(s),a=s}a.imageSmoothingEnabled=!0;var o=a.clientWidth,r=a.clientHeight;this.circleX=o/2,this.circleY=.38*r,this.circleRadius=.31*r,a&&(a.style.display="none",a.onclick=this.canvasOnClick.bind(this),a.addEventListener("mousemove",this.canvasOnMove.bind(this),!1),this.privateCanvas=document.createElement("canvas"),0==this.cameraRotation||2==this.cameraRotation?(this.privateCanvas.width=t,this.privateCanvas.height=i):(this.privateCanvas.width=i,this.privateCanvas.height=t))},userMedia:function(){return navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||null},setVideoInput:function(e){var t=document.getElementById("display");t&&e.playDevice(e)},playDevice:function(e){var t=document.getElementById("live"),i=document.getElementById("display"),a=i.getContext("2d",{alpha:!1}),n=null;"undefined"!=typeof facePhiUserControl&&null!==facePhiUserControl.config.videoSelectId&&(n=facePhiUserControl.config.videoSelectId);var s;window.stream&&window.stream.getTracks().forEach((e)=>{e.stop()}),s={video:{deviceId:n?{exact:n}:void 0,width:e.cameraWidth,height:e.cameraHeight},audio:!1};navigator.mediaDevices.getUserMedia(s).then(function(i){e.cameraStream=i,t.srcObject=i,t.addEventListener("loadedmetadata",e.videoLoaded.bind(e),!1),t.play()}).catch(function(){console.log("Camera error"),e.draw(e,e.imageCamera,a);var t=new CustomEvent("FPhi.UserControl.ExceptionCaptured.event",{detail:{message:"Camera not found.",exceptionType:0}});e.divContainer.dispatchEvent(t)})},gotDevices:function(e){var t=0;for(let a=0;a!==e.length;++a)"videoinput"===e[a].kind&&t++;this.cameraList=Array(t);var i=0;for(let t=0;t!==e.length;++t){var a=e[t];if("videoinput"===a.kind){var n=document.createElement("option");n.value=a.deviceId,n.text=a.label,this.cameraList[i]=n,i++}}var s=new CustomEvent("FPhi.UserControl.Cameras.event",{detail:{cameras:this.cameraList}});this.divContainer.dispatchEvent(s)},handleCameraError:function(e){console.log("Camera GetUserMedia error: ",e)},fromCameraToScreen:function(e,t){var i=e.cameraWidth,a=e.cameraHeight;(1==e.cameraRotation||3==e.cameraRotation)&&(i=e.cameraHeight,a=e.cameraWidth);var n=e.scaleRect({width:i,height:a},{x:0,y:0,width:e.canvasWidth,height:e.canvasHeight}),s=n.width/i,o=n.height/a,r={x:t.x*s,y:t.y*o,width:t.width*s,height:t.height*o},d=e.reflectedX(n.width,r.x+r.width);return r.x=d,r.x+=n.x,r.y+=n.y,r},fromCameraToScreenDetection:function(e,t){var i=e.cameraWidth,a=e.cameraHeight;(1==e.cameraRotation||3==e.cameraRotation)&&(i=e.cameraHeight,a=e.cameraWidth);var n=e.scaleRect({width:i,height:a},{x:0,y:0,width:e.canvasWidth,height:e.canvasHeight}),s=n.width/i,o=n.height/a,r={x:t.x*s,y:t.y*o,width:t.width*s,height:t.height*o},d=e.reflectedX(n.width,r.x+r.width);return r.x=d,r.x+=n.x,r.y+=n.y,r},faceInsideCircle:function(e,t){var i=Math.max,a=Math.min;if(e.faceTracking)return!0;var n=e.circleRadius,s=e.circleX,o=e.circleY,r={x:t.x,y:t.y,width:t.width,height:t.height},d=i(0,a(r.x+r.width,s+n)-i(r.x,s-n))*i(0,a(r.y+r.height,o+n)-i(r.y,o-n)),l=r.width*r.height;return!!(.75<d/l)},scaleRect:function(e,t,i){var a=t.x+t.width/2,n=t.y+t.height/2,s=t.width/e.width,o=t.height/e.height,r=e.width*s,d=e.height*s;return void 0==i?d<t.height&&(r=e.width*o,d=e.height*o):d>=t.height&&(r=e.width*o,d=e.height*o),{x:a-r/2,y:n-d/2,width:r,height:d}},scaleRectByFactor(e,t,i){var a=e.x+.5*e.width,n=e.y+.5*e.height,s={x:0,y:0,width:0,height:0};s.width=e.width*=t,s.height=e.height*=i,s.x=e.x,s.y=e.y;var o=e.x+.5*e.width,r=e.y+.5*e.height;return s.x-=o-a,s.y-=r-n,s},getGraphicalScore:function(e){var t=.9*(100*e/90*(100*e/90))+.1;return 1<t&&(t=1),t},draw:function(e,t,n){var s=Math.PI,o=n.canvas.clientWidth,r=n.canvas.clientHeight;e.fpsframes++,e.actualTimePrev=e.actualTime,e.actualTime=performance.now();var d=(e.actualTime-e.fpsTime)/1e3;1<d&&(e.fps=e.fpsframes/d,e.fpse=0<e.fpseframes?e.fpseframes/d:0,e.fpsTime=e.actualTime,e.fpsframes=0,e.fpseframes=0);var l="Normal";if("UCWaitingFaceStart"!=e.state&&"UCExtracting"!=e.state||e.faceAvailableDelayed||(l="Warning"),"UCLivenessMoveStabilizing"==e.state&&1!=e.livenessMoveLastStabilizedStatus&&2!=e.livenessMoveLastStabilizedStatus&&17!=e.livenessMoveLastStabilizedStatus&&(l="Warning"),e.faceTooFar&&(l="WarningTooFar"),e.iterateAutomata(e,t,n),e.secondsWidget=(e.actualTime-e.widgetTime)/1e3,e.secondsState=(e.actualTime-e.stateTime)/1e3,void 0!=e.elements){var c={};c.progress=0,c.faceTracking=e.faceTracking,c.faceDataRect=e.faceDataRect,c.leftEyeData=e.leftEyeData,c.rightEyeData=e.rightEyeData,c.state=e.state,c.livenessMoveLastStabilizedStatus=e.livenessMoveLastStabilizedStatus,"UCExtracting"==e.state?0==e.extractionTime?c.progress=0:c.progress=e.extractionTimePartial/(1e3*e.extractionTime):"UCShowResults"==e.state?c.progress=e.getGraphicalScore(e.lastExtractionResult.templateScore):"UCLivenessMoveDetecting"==e.state?c.livenessMoveDirection=e.livenessMoveDirection:"UCWaitingFaceStart"==e.state?c.progress=1:"UCErrors"==e.state&&(c.livenessDiagnostic=e.livenessDiagnostic),e.livenessMode==FPhi.LivenessMode.Move&&(c.liveness_move_last_result=e.livenessMoveLastAttemptSuccessful,c.liveness_move_attempts=e.livenessMoveActualSuccessfulAttempts+e.livenessMoveActualFailedAttempts,c.livenessMoveFailReason=e.livenessMoveFailReason);for(var m=0;m<e.elements.length;m++)if("button"!=e.elements[m].type&&"buttonImage"!=e.elements[m].type||!1!=e.interactible){var a=e.drawer.getLayout(e.resourceParent,e.elements[m].id,e.elements[m].type,e.secondsWidget,e.secondsState,l,c);if(null!=a){e.elements[m].layout=a;var v=e.elements[m].mode,g=!1;if(null!=v){for(var h=v.split("|"),u=0;u<h.length;u++)if(h[u]==l){g=!0;break}}else g=!0;if(!0==g){if("video"==e.elements[m].type)c.player=e.elements[m].videoPlayer;else if("camera"==e.elements[m].type){if(c.eyesYLevel=e.privateEyesYLevel,c.blindText="","UCLivenessDetectionStep1"==e.state){var p=e.actualTime-e.clockLiveness1;p/=1e3*e.liveness1Time,1<p&&(p=1),p=(p-1)*(p-1)*(p-1)+1,c.blind=.8*p}else if("UCLivenessDetectionStep2"==e.state)c.blind=.8,c.blindText=e.rm.translate("message_blink");else if("UCLivenessDetectionStep3"==e.state){var p=0;p=e.actualTime-e.clockLiveness3,p=.2*(p/(1e3*e.liveness3Time)),.2<p&&(p=.2),c.blind=.8+p}else if("UCWaitingEyeDetection"!=e.state)c.blind=0;else if(null==e.clockEyeDetectionDetected){var f=e.actualTime-e.clockEyeDetection,p=0;1e3>f?p=1:(p=(f-1e3)/(1e3*e.liveness1Time),0>p?p=0:1<p&&(p=1),p=1-p),c.blind=p}else{var f=e.actualTime-e.clockEyeDetectionDetected,p=.2*(f/(1e3*e.liveness3Time));0>p?p=0:.2<p&&(p=.2),c.blind=1-p}var C=e.privateCanvas.getContext("2d");switch(C.save(),e.cameraRotation){case 0:C.drawImage(t,0,0,e.cameraWidth,e.cameraHeight);break;case 1:C.translate(e.cameraHeight/2,e.cameraWidth/2),C.rotate(s/2*e.cameraRotation),C.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2);break;case 2:C.translate(e.cameraWidth/2,e.cameraHeight/2),C.rotate(s/2*e.cameraRotation),C.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2);break;case 3:C.translate(e.cameraHeight/2,e.cameraWidth/2),C.rotate(s/2*e.cameraRotation),C.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2);}switch(C.restore(),c.camera=e.privateCanvas,e.cameraRotation){case 0:case 2:c.width=e.cameraWidth,c.height=e.cameraHeight;break;default:c.width=e.cameraHeight,c.height=e.cameraWidth;}c.cameraRotation=e.cameraRotation}"button_info"==e.elements[m].id&&e.extractionMode==FPhi.UserControlMode.Authenticate&&e.livenessMode!=FPhi.LivenessMode.Blink||e.drawer.draw(n,a,e.resourceParent,e.elements[m].id,e.elements[m].type,e.secondsWidget,e.secondsState,l,c)}}}}else if("UCErrors"==e.state){n.fillStyle="white",n.fillRect(0,0,o,r),text=e.livenessErrorString,fontHeight=15*e.fontSizeFactor;var S=e.rm.getSetupResourceId("facephi-widget-conf","","font_warning_message");n.font=fontHeight+"px '"+S+"'",n.fillStyle="black";for(var M=text.split("\n"),x=0;x<M.length;x++){var i=n.measureText(M[x]),E=330*e.canvasSizeFactor+fontHeight*x;n.fillText(M[x],o/2-i.width/2,E)}var y=e.livenessErrorImage,a=e.scaleRect({width:y.width,height:y.height},{x:.03*o,y:.378*r,width:.94*o,height:.1*r},!0);n.drawImage(y,a.x,a.y,a.width,a.height),e.drawButton(e,n,{x:0,y:r-e.buttonHeight,width:o,height:e.buttonHeight},"Results","button_finish"),2<e.secondsState}if(e.debug&&null!=e.worker){var T=1;if(n.font="12px Verdana",n.fillStyle="gray",n.fillText("Version: "+e.extractorVersion,0,20*T),T++,n.fillText("State: "+e.state,0,20*T),T++,n.fillText("FPS: "+e.fps.toFixed(2),0,20*T),T++,n.fillText("FPS Extractor: "+e.fpse.toFixed(2),0,20*T),T++,n.fillText("Camera size: "+e.cameraWidth+"x"+e.cameraHeight+"px",0,20*T),T++,n.fillText("Canvas size: "+o+"x"+r+"px",0,20*T),T++,n.fillText("Camera rotation: "+e.cameraRotation,0,20*T),T++,n.fillText("WidgetTime: "+e.secondsWidget,0,20*T),T++,n.fillText("StateTime: "+e.secondsState,0,20*T),T++,n.fillText("Mode: "+l,0,20*T),T++,n.fillText("Images: "+e.privateImages.length,0,20*T),T++,n.fillText("Face available: "+e.faceAvailable,0,20*T),T++,n.fillText("EyesYLevel: "+Math.round(e.privateEyesYLevel),0,20*T),T++,e.livenessMode==FPhi.LivenessMode.Move)for(var w=e.privateLivenessImages.length,m=0;30>m;m++)n.fillStyle=m<e.livenessMoveNextIndex?"green":m<w?"red":"gray",n.fillRect(10*m+5,20*T+15,5,10);var L=e.lastDetectResult;if(null!=L){if("undefined"!=typeof L.face){n.fillText("Face: ["+L.face.x+","+L.face.y+","+L.face.width+","+L.face.height+"]",0,20*T),T++,n.beginPath(),n.lineWidth="3",n.strokeStyle="red";var I=e.fromCameraToScreen(e,{x:L.face.x,y:L.face.y,width:L.face.width,height:L.face.height});n.rect(I.x,I.y,I.width,I.height),n.stroke()}if("undefined"!=typeof L.leftEye){n.beginPath(),n.lineWidth="6",n.strokeStyle="red";var I=e.fromCameraToScreen(e,{x:L.leftEye.x,y:L.leftEye.y,width:1,height:1});n.rect(I.x,I.y,I.width,I.height),n.stroke()}if("undefined"!=typeof L.rightEye){n.beginPath(),n.lineWidth="6",n.strokeStyle="red";var I=e.fromCameraToScreen(e,{x:L.rightEye.x,y:L.rightEye.y,width:1,height:1});n.rect(I.x,I.y,I.width,I.height),n.stroke()}}}null!=e.worker&&setTimeout(e.draw,e.samplePeriod,e,t,n)},reduceRect:function(e,t){var i=e.width*(1-t),a=e.height*(1-t);return e.x+=(e.width-i)/2,e.y+=(e.height-a)/2,e.width=i,e.height=a,e},drawStringMultiline:function(e,t,i,n,s,o,r){var d=i.split("\n");t.imageSmoothingEnabled=!1,r=Math.round(r*e.fontSizeFactor),t.font="normal "+r+"px '"+o+"'",t.fillStyle=s;for(var l=0;l<d.length;l++)dim=t.measureText(d[l]),t.fillText(d[l],e.canvasWidth/2-dim.width/2,n+l*(r+1))},setOffInterface:function(e,t,i){e.beginPath(),e.lineWidth="5",e.fillStyle="gray",e.fillRect(0,0,i,i),e.stroke()},adaptText:function(e,t,i,a){t.font=a;var n=t.measureText(i).width;if(n>e){var s=a.indexOf("px"),o=a.substring(0,s);return o--,a=o+a.substring(s,a.length),t.font=a,this.adaptText(e,t,i,a)}return!0},reflectedX:function(e,t){return e-t},iterateAutomata:function(e){if(!1!=e.wasmReady&&!1!=e.cameraReady){if(!1==e.wasmInitiated){e.wasmInitiated=!0;var t=e.privateCanvas.width;t>e.privateCanvas.height&&(t=e.privateCanvas.height),e.postMessage(e,{cmd:"init",extractionMode:e.extractionMode,livenessMode:e.livenessMode,minIOD:.125*t,maxIOD:.27*t})}if("UCNothing"==e.state){if(0==e.queuedCommands&&e.wasmReady){var i=document.getElementById("gifWaiting");null!=i&&(i.style.display="none");var a=document.getElementById("display");null!=a&&(a.style.display="inline-block"),e.graph.sendMessage("SetMode//"+e.extractionMode+","+e.livenessMode+",0,"+(e.tutorial?1:0))}}else if("UCTutorialRegister1"==e.state)e.evaluateScenarioTimeout(e);else if("UCTutorialRegister2"==e.state)e.evaluateScenarioTimeout(e);else if("UCWaitingFaceStart"==e.state){if(0==e.queuedCommands&&e.wasmReady){var n=e.getImageData(e.privateCanvas);e.privateLastImage=n,e.postMessage(e,{cmd:"detect",data:n.pixels.data,width:n.width,height:n.height,format:FPhi.ImageFormat.RGBA_32bpp}),e.evaluateScenarioTimeout(e)}}else if("UCExtracting"==e.state){if(e.faceAvailableDelayed&&(e.extractionTimePartial+=e.actualTime-e.actualTimePrev),0==e.queuedCommands)if(e.actualTime-e.clockExtractionPure>e.detectionTimeout&&0==e.privateImages.length)e.livenessDiagnostic=-1,e.graph.sendMessage("Timeout");else if(!(0<e.extractionTime&&(e.extractionTimePartial<1e3*e.extractionTime||0==e.privateImages.length)))e.extractionMode==FPhi.UserControlMode.Register?e.graph.sendMessage("RegistrationFinished"):e.livenessMode==FPhi.LivenessMode.Blink?e.graph.sendMessage("SetLivenessBlink"):e.livenessMode==FPhi.LivenessMode.Move?e.graph.sendMessage("SetLivenessMove"):e.graph.sendMessage("AuthenticationFinished");else if(e.actualTime-e.clockExtractionPure>e.extractionTimeout)e.livenessDiagnostic=-1,e.graph.sendMessage("Timeout");else{var n=e.getImageData(e.privateCanvas);e.privateLastImage=n,e.postMessage(e,{cmd:"extractNextSmart",data:n.pixels.data,width:n.width,height:n.height,format:FPhi.ImageFormat.RGBA_32bpp})}}else if("UCShowResults"==e.state)e.evaluateScenarioTimeout(e);else if("UCWaitingEyeDetection"==e.state){if(performance.now()-e.clockEyeDetection>e.detectionTimeout)return e.livenessDiagnostic=-1,void e.graph.sendMessage("Timeout");var s=performance.now()-e.clockEyeDetection;if(1e3<s&&null==e.clockEyeDetectionDetected&&s<1e3+1e3*e.liveness1Time)return;if(s>1e3+1e3*e.liveness1Time&&null!=e.clockEyeDetectionDetected)return void e.graph.sendMessage("ResetLivenessBlink");if(null!=e.clockEyeDetectionDetected&&performance.now()-e.clockEyeDetectionDetected>1e3*e.liveness3Time&&e.graph.sendMessage("Timer"),null==e.clockEyeDetectionDetected&&0==e.queuedCommands&&e.wasmReady){var n=e.getImageData(e.privateCanvas);e.privateLastImage=n,e.postMessage(e,{cmd:"detect",data:n.pixels.data,width:n.width,height:n.height,format:FPhi.ImageFormat.RGBA_32bpp}),e.evaluateScenarioTimeout(e)}}else if("UCLivenessDetectionStep1"==e.state)performance.now()-e.clockLiveness1>1e3*e.liveness1Time&&e.graph.sendMessage("Timer");else if("UCLivenessDetectionStep2"==e.state){if(0==e.queuedCommands&&e.wasmReady){var o=e.getImageData(e.privateCanvas);e.privateLivenessImageTemp=o,e.postMessage(e,{cmd:"livenessTimerAdd",milliseconds:performance.now()-e.clockLiveness2})}}else if("UCLivenessDetectionStep3"==e.state)null!=e.clockLiveness3_finish&&performance.now()-e.clockLiveness3_finish>1e3*e.liveness3Time&&e.graph.sendMessage("EyeDetectionNeeded");else if("UCLivenessMoveStabilizing"==e.state){if(10<=e.secondsState){e.livenessDiagnostic=-1,e.livenessMoveStabilizedStatusHistory.push(-1),e.graph.sendMessage("Timeout");var r=new CustomEvent("FPhi.UserControl.Stabilizing.event",{detail:-1});this.divContainer.dispatchEvent(r)}else if(0==e.queuedCommands&&e.wasmReady){var n=e.getImageData(e.privateCanvas);e.privateLastImage=n,e.postMessage(e,{cmd:"nextLivenessMoveStabilization",data:n.pixels.data,width:n.width,height:n.height,format:FPhi.ImageFormat.RGBA_32bpp})}}else if("UCLivenessMoveDetecting"!=e.state)"UCLivenessMoveProcessing"==e.state?0==e.queuedCommands&&e.wasmReady&&(!e.livenessCalculating&&e.livenessMoveNextIndex>=e.privateLivenessImages.length?(e.livenessCalculating=!0,e.postMessage(e,{cmd:"evaluateLivenessMove",timer:e.livenessMoveTimer})):!e.livenessCalculating&&e.livenessMoveNextIndex<e.privateLivenessImages.length&&0<e.privateLivenessImages.length&&(e.livenessCalculating=!0,n=e.privateLivenessImages[e.livenessMoveNextIndex],e.postMessage(e,{cmd:"nextLivenessMoveImage",data:n.pixels.data,width:n.width,height:n.height,format:FPhi.ImageFormat.RGBA_32bpp}))):"UCLivenessMoveInfo"==e.state&&e.secondsState>e.livenessMoveInfoTime&&(e.livenessDiagnostic=-1,e.graph.sendMessage("Timeout"));else if(.25<e.secondsState){var d=Math.round(1e3*e.secondsState);if(e.livenessMoveTimer.Add(d)){var n=e.getImageData(e.privateCanvas);e.privateLivenessImages.push(n),this.logAllImages&&(this.privateImages.push(n),this.privateLivenessResults.push(this.secondsWidget)),0==e.queuedCommands&&e.wasmReady&&!e.livenessCalculating&&e.livenessMoveNextIndex<e.privateLivenessImages.length&&0<e.privateLivenessImages.length&&(e.livenessCalculating=!0,n=e.privateLivenessImages[e.livenessMoveNextIndex],e.postMessage(e,{cmd:"nextLivenessMoveImage",data:n.pixels.data,width:n.width,height:n.height,format:FPhi.ImageFormat.RGBA_32bpp}))}e.livenessMoveTimer.IsFull()&&e.graph.sendMessage("LivenessTimerFull")}}},evaluateScenarioTimeout:function(e){0<e.sceneTimeout&&performance.now()-e.clockNewScenario>1e3*e.sceneTimeout&&(e.livenessDiagnostic=-1,e.graph.sendMessage("Timeout"))},getVideoSources:function(e){if(navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(function(t){videoSourceId=t.filter(function(e){return"video"==e.kind}).map(function(e){return e.id}),selectedSource=videoSourceId[0],e.setVideoInput(e)}):MediaStreamTrack.getSources(function(t){videoSourceId=t.filter(function(e){return"video"==e.kind}).map(function(e){return e.id}),selectedSource=videoSourceId[0],e.setVideoInput(e)}),null==selectedSource){FacePhiDisplayErrorImage(facePhiUserControl.config.width,folderPath+commonPath+"/Images/errorNoCamsEs.png",folderPath+commonPath+"/Images/errorNoCamsEn.png","FacePhiWidgetWeb",e.divContainer,0,"","",0,Verdana,"Bold","black",0);var t=new CustomEvent("FPhi.UserControl.ExceptionCaptured.event",{detail:{message:"Camera not found.",exceptionType:0}});e.divContainer.dispatchEvent(t)}},getScriptPath:function(e){var t,i=document.getElementsByTagName("script"),a=0;for(t=0;t<i.length;t++)-1<i[t].src.indexOf(e)&&(a=t);return i[a].src.split("/").slice(0,-1).join("/")+"/"},distAlgSustitution:function(e,t,i){for(var n,s,o=Number.MAX_VALUE,r=1;r<t.length;r++){s=t.slice(),s[r]=i,s.sort(function(e,t){return e.time-t.time});var a=e.desviacionTipica(e,s);a<o&&(o=a,n=s)}return n},betterSustitution:function(e,t,i){for(var n,s=Number.MAX_VALUE,o=0,r=0;r<t.length;r++)n=t[r].extractionResult.facialScore,n<s&&(s=n,o=r);i.extractionResult.facialScore>s&&(t[o]=i)},sortImagesByFacialScore:function(e,t){t.sort(function(e,t){return afs=void 0==e.extractionResult?0:e.extractionResult.facialScore,bfs=void 0==t.extractionResult?0:t.extractionResult.facialScore,bfs-afs})},desviacionTipica:function(e,t){for(var i,n=e.media(e,t),s=0,o=1;o<t.length;o++)i=t[o].time-t[o-1].time,s+=(i-n)*(i-n);return s=Math.sqrt(s/(t.length-2)),s},media:function(e,t){for(var i,n=0,s=1;s<t.length;s++)i=t[s].time-t[s-1].time,n+=i;return n/(t.length-1)},OnResourceManagerLoaded:function(){this.rm=new FPhi.ResourceManager(this.baseURL,this.language,this,this.OnResourceManagerStatus,this.dpiList,window.devicePixelRatio,this.canvasSizeFactor)},OnResourceManagerStatus:function(e,t){t&&(e.debug&&console.log("Timing-RM-loaded: "+performance.now()),e.rmReady=!0,e.CheckDependencies(e))},OnGraphLoaded:function(){this.graph=new FPhi.Graph(this.path+this.graphPath,this.OnGraphReady.bind(this),this.OnGraphNewState.bind(this))},OnGraphReady:function(){this.graphReady=!0,this.debug&&console.log("Timing-Graph-loaded: "+performance.now()),this.CheckDependencies(this)},OnDrawerLoaded:function(){this.drawer=new FPhi.Drawer(this.extractionMode,this.livenessMode,this.canvasSizeFactor,this.fontSizeFactor),this.debug&&console.log("Timing-Drawer-loaded: "+performance.now()),this.CheckDependencies(this)},CheckDependencies:function(e){if(!0==e.rmReady&&e.drawer!==void 0&&!0==e.graphReady&&"UCNothing"!=e.graph.state){var t=document.getElementById("gifWaiting");null!=t&&(t.style.display="inline-block");var i=document.getElementById("display");null!=i&&(i.style.display="none"),e.drawer.rm=e.rm,e.drawer.setCanvasSize(e.canvasWidth,e.canvasHeight),e.graph.setInitialState("UCNothing");var a=new CustomEvent("FPhi.UserControl.ModuleLoaded.event");e.divContainer.dispatchEvent(a),this.debug&&console.log("Timing-LoadedEvent: "+performance.now())}},videoLoaded:function(t){this.cameraWidth=t.target.videoWidth,this.cameraHeight=t.target.videoHeight,0==this.cameraRotation||2==this.cameraRotation?(this.privateCanvas.width=this.cameraWidth,this.privateCanvas.height=this.cameraHeight):(this.privateCanvas.width=this.cameraHeight,this.privateCanvas.height=this.cameraWidth),this.cameraReady=!0,this.debug&&console.log("Timing-Camera-ready: "+performance.now());var e=document.getElementById("live"),i=document.getElementById("display"),a=i.getContext("2d",{alpha:!1});this.draw(this,e,a)},videoFrame:function(t){var e=this.canvasVideoPlayer.getContext("2d");e.drawImage(t.target,0,0)},videoplayerEnded:function(t){"UCWizardCompleted"==this.state?this.graph.sendMessage("VideoFinished"):t.target.play()}};function arrayBufferToBase64(e){for(var t="",a=new Uint8Array(e),n=a.byteLength,s=0;s<n;s++)t+=String.fromCharCode(a[s]);return window.btoa(t)}var facePhiUserControlWasm={GetPluginEnabled:function(){return null!=privateFacePhiConfig.WasmControl&&privateFacePhiConfig.WasmControl.wasmReady},OnExtractionFinish:function(e){var t=null,i=null,a=null;e.detail.template&&0<e.detail.template.byteLength&&(t=arrayBufferToBase64(e.detail.template)),e.detail.templateRaw&&0<e.detail.templateRaw.byteLength&&(i=arrayBufferToBase64(e.detail.templateRaw)),0<e.detail.images.length&&(a=e.detail.images);var n={Template:t,Images:a,TimeStamp:e.detail.timeStamp,TemplateRaw:i,LivenessMoveFails:e.detail.livenessMoveFails,SunGlassesScore:e.detail.sunGlassesScore,LivenessMoveHistory:e.detail.livenessMoveHistory,livenessMoveStabilizedHistory:e.detail.livenessMoveStabilizedHistory,LivenessMoveStabilizedStatus:e.detail.livenessMoveStabilizedStatus};FacePhiCreateWaiting(document.getElementById(facePhiUserControl.config.divId)),facePhiUserControl.events.ExtractionFinished(n)},OnTutorialFinish:function(){FacePhiCreateWaiting(document.getElementById(facePhiUserControl.config.divId)),facePhiUserControl.events.TutorialFinished()},OnTutorialCancel:function(){FacePhiCreateWaiting(document.getElementById(facePhiUserControl.config.divId)),facePhiUserControl.events.TutorialCanceled()},OnLivenessError:function(e){var t=null;-1<e.detail.livenessErrorType&&(t={LivenessErrorType:e.detail.livenessErrorType,LivenessMoveFails:e.detail.livenessMoveFails,LivenessMoveHistory:e.detail.livenessMoveHistory,livenessMoveStabilizedHistory:e.detail.livenessMoveStabilizedHistory,LivenessMoveStabilizedStatus:e.detail.livenessMoveStabilizedStatus},e.detail.images&&(t.Images=e.detail.images),e.detail.timeStamp&&(t.TimeStamp=e.detail.timeStamp),e.detail.sunGlassesScore&&(t.SunGlassesScore=e.detail.sunGlassesScore)),facePhiUserControl.events.LivenessError(t)},OnTimeoutErrorButtonClick:function(){FacePhiCreateWaiting(document.getElementById(facePhiUserControl.config.divId)),facePhiUserControl.events.TimeoutErrorButtonClick()},OnLivenessErrorButtonClick:function(){FacePhiCreateWaiting(document.getElementById(facePhiUserControl.config.divId)),facePhiUserControl.events.LivenessErrorButtonClick()},OnExceptionCaptured:function(e){var t=null,i=null;e.detail.message&&(t=e.detail.message),-1<e.detail.exceptionType&&(i=e.detail.exceptionType);var a={Message:t,ExceptionType:i};facePhiUserControl.events.ExceptionCaptured(a)},OnExtractionTimeout:function(e){var t={LivenessErrorType:e.detail.livenessErrorType,LivenessMoveFails:e.detail.livenessMoveFails,LivenessMoveHistory:e.detail.livenessMoveHistory,livenessMoveStabilizedHistory:e.detail.livenessMoveStabilizedHistory,LivenessMoveStabilizedStatus:e.detail.livenessMoveStabilizedStatus};facePhiUserControl.events.ExtractionTimeout(t)},OnUserCancel:function(){FacePhiCreateWaiting(document.getElementById(facePhiUserControl.config.divId)),facePhiUserControl.events.CancelledDetected()},OnUserControlLoaded:function(){facePhiUserControl.events.UserControlLoaded()},OnStabilizing:function(e){facePhiUserControl.events.Stabilizing({Status:e.detail})},OnCamerasRetrieved:function(e){var t=null;e.detail.cameras&&(t=e.detail.cameras),facePhiUserControl.events.CamerasRetrieved(t)}},privateFacePhiConfig={WasmControl:null,cached:!1,WasmTutorial:null};if(FacePhiCacheWasm=function(){facePhiUserControl.config.debug&&console.log("caching usercontrol"),privateFacePhiConfig.cached=!0;var e=FPhi.UserControl.prototype.getScriptPath("FPhi.Widget.wasm.js")+"FPhi.Widget.Resources/";null!=privateFacePhiConfig.WasmControl&&(privateFacePhiConfig.WasmControl=null),privateFacePhiConfig.WasmControl=new FPhi.UserControl(facePhiUserControl.config.divId,facePhiUserControl.config.preferedResolutionWidth,facePhiUserControl.config.preferedResolutionHeight,facePhiUserControlWasm.OnUserControlLoaded,facePhiUserControlWasm.OnExtractionFinish,facePhiUserControlWasm.OnUserCancel,facePhiUserControlWasm.OnExceptionCaptured,facePhiUserControlWasm.OnExtractionTimeout,facePhiUserControlWasm.OnLivenessError,facePhiUserControlWasm.OnLivenessErrorButtonClick,facePhiUserControlWasm.OnTimeoutErrorButtonClick,facePhiUserControlWasm.OnStabilizing,facePhiUserControl.config.culture,e,[163,326,489],facePhiUserControl.config.width,facePhiUserControl.config.width),privateFacePhiConfig.WasmControl.videoSelectId=facePhiUserControl.config.videoSelectId,privateFacePhiConfig.WasmControl.cameraRotation=facePhiUserControl.config.cameraRotation,privateFacePhiConfig.WasmControl.cropImage=facePhiUserControl.config.cropImage,privateFacePhiConfig.WasmControl.cropFactor=facePhiUserControl.config.cropFactor,privateFacePhiConfig.WasmControl.resizeFactor=facePhiUserControl.config.resizeFactor,privateFacePhiConfig.WasmControl.sceneTimeout=facePhiUserControl.config.sceneTimeout,privateFacePhiConfig.WasmControl.debug=facePhiUserControl.config.debug,privateFacePhiConfig.WasmControl.interactible=facePhiUserControl.config.interactible,privateFacePhiConfig.WasmControl.registerTime=facePhiUserControl.config.registerTime,privateFacePhiConfig.WasmControl.authenticateTime=facePhiUserControl.config.authenticateTime,privateFacePhiConfig.WasmControl.tutorial=facePhiUserControl.config.tutorial,privateFacePhiConfig.WasmControl.logImages=facePhiUserControl.config.logImages,privateFacePhiConfig.WasmControl.logAllImages=facePhiUserControl.config.logAllImages,privateFacePhiConfig.WasmControl.forceMoveDirection=facePhiUserControl.config.forceMoveDirection,privateFacePhiConfig.WasmControl.graphPath=facePhiUserControl.config.graphPath,privateFacePhiConfig.WasmControl.faceTracking=facePhiUserControl.config.faceTracking,privateFacePhiConfig.WasmControl.livenessPrecision=facePhiUserControl.config.livenessPrecision,privateFacePhiConfig.WasmControl.livenessMoveActualFailedAttempts=facePhiUserControl.config.livenessMoveInitialError,privateFacePhiConfig.WasmControl.livenessMoveInfoTime=facePhiUserControl.config.livenessMoveInfoTime,privateFacePhiConfig.WasmControl.imageFormat=facePhiUserControl.config.imageFormat,facePhiUserControl.config.extractionMode==facePhiUserControlType.extractionMode.Authenticate&&(privateFacePhiConfig.WasmControl.extractionMode=FPhi.UserControlMode.Authenticate),facePhiUserControl.config.extractionMode==facePhiUserControlType.extractionMode.Register&&(privateFacePhiConfig.WasmControl.extractionMode=FPhi.UserControlMode.Register),facePhiUserControl.config.livenessMode==facePhiUserControlType.livenessMode.Move&&(privateFacePhiConfig.WasmControl.livenessMode=FPhi.LivenessMode.Move),facePhiUserControl.config.livenessMode==facePhiUserControlType.livenessMode.Blink&&(privateFacePhiConfig.WasmControl.livenessMode=FPhi.LivenessMode.Blink),facePhiUserControl.config.livenessMode==facePhiUserControlType.livenessMode.None&&(privateFacePhiConfig.WasmControl.livenessMode=FPhi.LivenessMode.None)},FacePhiShowWasm=function(e){facePhiUserControl.config.debug&&console.log("cached: "+privateFacePhiConfig.cached),!1==privateFacePhiConfig.cached&&FacePhiCacheWasm(e),privateFacePhiConfig.cached=!1,privateFacePhiConfig.WasmControl.Start()},FacePhiGetCameras=function(e,t){return this.divContainer=document.getElementById(e),this.divContainer.addEventListener("FPhi.UserControl.Cameras.event",t,!0),FPhi.UserControl.prototype.GetAvailableCameras()},FPhi.Timer===void 0){FPhi.Timer=class{constructor(){this.desiredFPS=0,this.desiredFrameTime=0,this.tolerance=.5,this.desiredRelativeTolerance=0,this.maxSize=0,this.k=0,this.timeCodes=[],this.desiredIndAll=0,this.timeLapse=0,this.initialOffset=0,this.currentOffset=0}SetValues(e,t,i){return!(0>=e)&&!(0>=t)&&!(0>i)&&(this.desiredFPS=t,this.desiredFrameTime=1e3*(1/t),this.desiredRelativeTolerance=this.desiredFrameTime*this.tolerance,this.maxSize=Math.ceil(this.desiredFPS*e/1e3),this.timeCodes=[],this.timeLapse=e,this.initialOffset=i,!0)}GetTimeLapse(){return this.timeLapse}GetFps(){return this.desiredFPS}Reset(){this.timeCodes=[],this.k=0,this.desiredIndAll=-1}Add(e){if(0>e)return!1;if(this.k>=this.maxSize)return!1;if(0==this.currentOffset&&(this.currentOffset=e),Math.abs(e-this.currentOffset)<this.initialOffset)return!1;if(0==this.k)this.timeCodes.push(e),this.k++;else{var t=Math.round(e/this.desiredFrameTime);t<=this.desiredIndAll&&t++;var i=!!(e-this.timeCodes[this.k-1]>this.desiredRelativeTolerance),a=!!(t*this.desiredFrameTime-e<this.desiredRelativeTolerance);if(i&&a)this.timeCodes.push(e),this.k++,this.desiredIndAll=t;else return!1}return!0}IsFull(){return this.k>=this.maxSize}GetTimeCodes(){return this.timeCodes}}}